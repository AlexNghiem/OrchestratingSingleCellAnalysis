---
title: "Usage Statistics for Bioconductor Packages"
author: "Stephanie Hicks"
output: 
    html_document:
        theme: cosmo 
        toc: true
        toc_float: true
        highlight: tango
        number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Figure 1: Useage statistics

Create a figure of growth of single-cell 
Bioconductor packages (contributions and downloads) 
over time (2009-2018). 

Load libraries

```{r}
library(BiocPkgTools)
library(tidyverse)
library(lubridate)
library(cowplot)
```

Load data from `BiocPkgTools`. The first 
dataset has information about the BiocViews and 
the second dataset has information about the 
number of downloads. 

```{r}
pkg_data <- BiocPkgTools::biocPkgList()
pkgs <- BiocPkgTools::biocDownloadStats()
```

Next, we subset and search for Bioconductor packages
with `SingleCell`, `RNASeq` and `Microarray` BiocViews. 

```{r}
sc_pkgs <- pkg_data %>% 
  filter(str_detect(biocViews, "SingleCell")) %>% 
  pull(Package)

bulk_pkgs <- pkg_data %>% 
  filter(str_detect(biocViews, "RNASeq")) %>% 
  pull(Package)

microarray_pkgs <- pkg_data %>% 
  filter(str_detect(biocViews, "Microarray")) %>% 
  pull(Package)
```

Create a figure containing packages contributed
```{r}
p_number_pkgs <- pkgs %>% 
  filter(Month != "all", Year != 2019, 
         repo=="Software", 
         Package %in% c(sc_pkgs, bulk_pkgs, microarray_pkgs)) %>%
  mutate(Assay=fct_relevel(factor(ifelse(Package %in% sc_pkgs, "Single Cell", 
                     ifelse(Package %in% bulk_pkgs, "Bulk RNA-Seq", "Microarray"))), 
                        "Microarray")) %>% 
  select(Package, Year, Assay) %>%
  distinct() %>%
  group_by(Year, Assay) %>%
  summarize(total_packages = n()) %>%
  arrange(desc(Year)) %>%
  ggplot(aes(x=Year,y=total_packages, color=Assay)) + 
  geom_point(size=4) + scale_y_log10() + 
  xlab("Year") + ylab("Total Packages Contributed\n(cumulative sum)") 
```

and packages downloaded
```{r}
p_distinct_IPs <- pkgs %>% 
  filter(Month != "all", Year != 2019, 
         repo=="Software", 
         Package %in% c(sc_pkgs, bulk_pkgs, microarray_pkgs)) %>%
   mutate(Assay=fct_relevel(factor(ifelse(Package %in% sc_pkgs, "Single Cell", 
                     ifelse(Package %in% bulk_pkgs, "Bulk RNA-Seq", "Microarray"))), 
                        "Microarray")) %>% 
  group_by(Year, Assay) %>%
  summarize(Nb_of_distinct_IPs = sum(Nb_of_distinct_IPs), 
            Nb_of_downloads = sum(Nb_of_downloads)) %>% 
  ggplot(aes(x=Year,y=Nb_of_distinct_IPs, color=Assay)) + 
  geom_point(size=4) + scale_y_log10() + 
  xlab("Year") + ylab("Total Packages Downloaded  ")
```


Final figure putting everything together using `cowplot`. 

```{r}
pdf("data_analysis/figs/bioc-three-assays.pdf", width=9, height=4)
p <- plot_grid(p_number_pkgs + theme(legend.position = "none"), 
               p_distinct_IPs + theme(legend.position = "none"), ncol=2, labels = LETTERS[1:2])
legend <- get_legend(p_number_pkgs + theme(legend.position = "bottom"))
p2 <- plot_grid(p,legend, rel_heights = c(2,.15), ncol=1) # c(1.25, .23))
title <- ggdraw() + draw_label("Usage and impact statistics for Bioconductor software packages", fontface='bold')
plot_grid(title, p2, ncol=1, rel_heights=c(0.1, 1)) # rel_heights values control title margins
dev.off()
```